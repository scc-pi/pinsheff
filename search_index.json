[["index.html", "Notes Welcome", " Notes Laurie Platt 2021-03-19 Welcome This is a place for ad-hoc notes, mainly to do with scripting and mainly R scripts. It’s somewhere to store lessons learnt and examples. A resource to remind yourself if you return to something after a while away from it, or to smooth your path a little if it’s something new. There are many excellent online resources that these notes will point to and will not attempt to replace. Overtime some notes may mature into package vignettes or become accepted as good practice and included in the Methods Manual. Hopefully, others from the Performance &amp; Intelligence Team, or elsewhere in Sheffield City Council, will contribute to these notes. However, currently it’s just one person and is biased to one person’s recent experience: ETL, geocoding and spatial analysis. Notes about modelling and visualisations are lacking. As well as the contributors and content, the purpose and scope is open to change. I hope you find the notes useful. "],["github.html", "Chapter 1 Version Control &amp; GitHub 1.1 Why version control? 1.2 GIT 1.3 GitHub 1.4 Git &amp; RStudio", " Chapter 1 Version Control &amp; GitHub You don’t have to be familiar with version control, Git and GitHub to make use of these notes or the contents of the scc-pi repositories. If you’re new to scripting and R, then visualisations or using R Markdown are better starting points than version control. These notes are public, but to contribute i.e. edit them, you need a GitHub account and to be granted permission by an owner of scc-pi (try Laurie first, but Giles and Anne could help too). Then you can edit directly in GitHub via your browser. You also need a GitHub account and permission to access one of our private repositories, but not for our public repositories, to download a file, copy &amp; paste code, or source and use a function: # Load functions from a public scc-pi repository source(&quot;https://raw.githubusercontent.com/scc-pi/functions/main/Examples.R&quot;) # Call one of our Sheffield area functions that returns LSOA codes shef_lsoa_codes() %&gt;% head(5) %&gt;% #only display the first 5 records knitr::kable() #display them in a nice table ## [1] &quot;Table&quot; LSOA11CD LSOA11NM E01008124 Sheffield 012F E01008125 Sheffield 009G E01007917 Sheffield 071B E01033273 Sheffield 042F E01007967 Sheffield 045B Try raising an issue if you spot a problem, have a suggestion or a question. 1.1 Why version control? When scripting you might make a backup copy of a file, so if your new changes break what was previously working you can revert to the backup copy. If you’re collating contributions to a document from different people you might use their initials in the file names to indicate and keep track of who’s made contributions in what version e.g. “BI_Principles-GR.docx” and “BI_Principles-NM.docx”. These are both examples of manual version control. When we talk about version control and scripting we typically mean a version control system. A tool that assists with tracking changes to files over time and by different people. Such systems also usually include reasons for the changes, and file, or rather version, comparison functionality. So a version control system is a backup/audit trail/collaboration thing. 1.2 GIT Git is an open-source distributed version control system for tracking changes in source code during software development. 1.3 GitHub GitHub is a product that offers Git-based source control repositories. Other products also offer Git-based repositories, such as GitLab, BitBucket, and Azure DevOps. Our scc-pi GitHub organisation is a free account. It has had no approval as such. If using it proves successful we will need to discuss approval with BCIS. 1.3.1 Github security &amp; data protection Assuming that GitHub.com is hosted in the US, it will not meet our data protection obligations. Either way, we’ve not checked compliance with Information Governance, so storing PID (Person Identifiable Data), or anything commercially confidential or politically sensitive, on GitHub.com is currently a no no. As an additional precaution, any projects related to such information should be held in a private repository. See the section on RStudio security &amp; data protection for further considerations. Microsoft own GitHub and GitHub Enterprise Server is the on-premises deployment of GitHub.com that could be hosted on our own Azure environment. 1.3.2 Forking and pull requests GitHub forking and pull requests are common workflows when collaborating on a repository. TODO - we’ll have more to add on this if we collaborate on a repository 1.3.3 Other features GitHub now allows private repositories on free organisation accounts, but not all GitHub features are available. The evolution of a repository is captured by commits i.e. the changes to files in the repository. However, the original issue, ideas or discussion surrounding a commit is captured in a GitHub issue. You can link a commit to an issue by including the issue number prefixed by # in the commit message. I’ve used a GitHub project to organise our private C19Surveillance repository as a kanban board. However, a project is not restricted to issues or a single repository. GitHub pages and actions have been used to publish these notes. There are also other GitHub features to explore. 1.4 Git &amp; RStudio Introduction to GitHub on the GitHub Learning Lab is a good place to get started and become familiar with some initial concepts and the GitHub website. To use GitHub with RStudio there’s a thorough step-by-step guide, Happy Git with R by Jenny Bryan. My main recommendation is to setup the connection using keys for SSH. This connection method by-passes the issues I’ve had with the Council’s proxy server and using the HTTPS connection method. I’ve also had no issues since working from home and connecting via the Tunnel. I frequently return to Jenny Bryan’s book, especially for chapters 15, 16 and 17 on different ways of setting up a local RStudio project connected to GitHub. So far, I’ve mainly stuck with Chapter 15 New project, GitHub first. "],["r.html", "Chapter 2 R &amp; RStudio 2.1 Why script? 2.2 Style guide 2.3 RStudio security &amp; data protection 2.4 Getting started 2.5 RStudio tips 2.6 Further resources", " Chapter 2 R &amp; RStudio 2.1 Why script? I initially started scripting in Python to automate some spatial analysis tasks, but soon realised that reproducibility was the main advantage. Iterating, improving a process incrementally and at the end verifying the results by re-running the script. There’s an element of self-documentation with scripting, so it’s easier to return to a scripted task after a bit of time away from it, or pick up a scripted task from a colleague. However, in-line comments and adherence to a style guide make a big difference to just how easy it is. Version control and collaboration are also easier with scripting than GUI tools. Scripting is not always better than using GUI tools. There’s a good reason that more people use Mac OS and Windows than Unix Bash. Scripting or GUI tools is a horses for courses question, and some GUI workflow tools (e.g. FME, Simul8 and ModelBuilder in ArcGIS) sit somewhere in the middle. 2.2 Style guide Something I need to pay more attention to is following the tidyverse style guide, which benefits from supporting tools and familiarity via tidyverse package documentation. Scripting to the same style guide makes collaboration easier. Which style guide is less important than collaborators scripting to the same style guide. 2.3 RStudio security &amp; data protection 2.3.1 Workspace To encourage reproducible R scripts, Hadley Wickham recommends not preserving your workspace between sessions. This entails deselecting a couple of options to save and restore .Rdata (see chapter 8 Workflow: projects in Hadley’s R4DS book). Hadley’s recommendation also reduces the chances of inadvertently sharing PID in a GitHub repository. However, .Rdata should also be included in the .gitignore file and the repository set to private. 2.3.2 Passwords It’s poor practice to include login details in code. I use the .Renviron file option for securing credentials. However, if you’re sharing the script you can anticipate that the environment variable might not be set and use the RStudio API to prompt for credentials. For example: portal_pwd &lt;- Sys.getenv(&quot;portal_pwd&quot;) if(length(portal_pwd) == 0){ portal_pwd &lt;- rstudioapi::askForPassword(&quot;Portal password&quot;) } 2.4 Getting started I’m not going to provide advice on getting started, other than signposting to the excellent resources listed on the RStudio beginners page: RStudio Education - Beginners 2.5 RStudio tips 2.5.1 Code display A few non-default Global Options, under Code and Display, make it a little easier to read and write code: Show margin (aim to limit a line of code to 80 characters) Highlight R function calls Rainbow parentheses (since RStudio v1.4) 2.5.2 Document outline and headings Code sections and subsections are useful: # Prefix a section with a hash tag and suffix with 4 or more dashes ---- ## Subsections have additional hash tags ---- The sections can be collapsed and are also listed in the document outline pane: 2.5.3 ViewPipeSteps addin The pipe %&gt;% is useful for reading and writing code, but can make debugging cumbersome. The ViewPipeSteps addin lets you view the output of your pipe chain after each step. To install: devtools::install_github(&quot;daranzolin/ViewPipeSteps&quot;) library(ViewPipeSteps) To use: 2.5.4 Shortcuts RStudio has lots of shortcuts. What you find most useful is down to preference and the areas of the IDE you use most often. These are the shortcuts I’ve found most useful: Ctrl + Enter run selected lines Ctrl + Alt + P re-run previous Ctrl + Shift + C comment/uncomment lines Ctrl + Alt + A reformat code Ctrl + Shift + R insert section Alt + - assignment operator &lt;- Ctrl + Shift + M pipe operator %&gt;% Ctrl + left mouse button View the object clicked Ctrl + Shift + F10 Restart R session Ctrl + Shift + P Command palette TODO - Write settings 2.6 Further resources 5 tips for writing clean R code,by Marcin Dubel in R bloggers (15 March 2021) "],["rmd.html", "Chapter 3 R Markdown 3.1 R Markdown vs Markdown 3.2 Child markdown iteration 3.3 Notebooks 3.4 Bookdown 3.5 Further resources 3.6 R Markdown tips", " Chapter 3 R Markdown 3.1 R Markdown vs Markdown TODO 3.2 Child markdown iteration TODO - example based on C19 UoS example - not a prominent technique because the demand for such reports has largely been superseded by browser base dashboards such as those provided via Power BI or Shiny 3.3 Notebooks TODO - technical vs data exploration - don’t add to github 3.4 Bookdown These notes are written using the bookdown package , which was built on top of R Markdown and knitr. Each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading #. 3.4.1 Themes TODO GitBook style Theming R4DS source 3.4.2 Publishing These notes are published on GitHub Pages with GitHub Actions. A GitHub Action has been configured to start when there’s a push to the master branch. The Action renders the Rmd files in the master branch to HTML and then deploys the HTML files as a static website to a branch called gh-pages. Alternatives to using GitHub Actions include Travis and Jekyll. I used the steps outlined in the following blog post: How to publish bookdown projects with GitHub Actions on GitHub Pages. However, I did a lot of the git bash commands manually and there were a couple of fixes I made to the deploy_bookdown.yaml file: 1. Under … uses: Cecilapp/GitHub-Pages-deploy@master … I added … with: build_dir: _book/ email: ${{ secrets.EMAIL }} 2. I used GITHUB_TOKEN rather than GH_PAT, as per a recent change to GitHub-Pages-deploy. 3.5 Further resources Authoring Books with R Markdown by Yihui Xie is the definitive resource for bookdown. 3.6 R Markdown tips 3.6.1 Markdown visual editor The RStudio v1.4 release includes a visual editor for markdown, which makes it more like using MS Word: 3.6.2 Chunk named setup Naming a code block setup means that after you restart RStudio and execute any code in the middle of your markdown document, the setup block will run first. For example, to make sure your libraries are loaded first: ```{r, setup, message = FALSE, warning = FALSE} # Packages library(tidyverse) ``` "],["api.html", "Chapter 4 APIs 4.1 REST APIs 4.2 Wrappers 4.3 Rectangling", " Chapter 4 APIs 4.1 REST APIs RESTful TODO - Foundation for Council services 4.2 Wrappers TODO 4.3 Rectangling Data returned from REST APIs are typically provided in a hierarchical structure and JSON is the most common format. To structure the data from the API into a more familiar tabular structure I recommend the tidyverse Rectangling vignette. TODO scc-pi functions with rectangling e.g. postcode and geocoding "],["python.html", "Chapter 5 Python 5.1 Reticulate 5.2 ArcGIS &amp; API wrappers", " Chapter 5 Python TODO: Move chapter to after R? Python and R are both popular data analysis scripting languages. Python is a general-purpose language with an easy-to-understand syntax. R’s functionality was developed with statisticians in mind and is popular in academia and research. 5.1 Reticulate The reticulate R package allows R to integrate with Python. RStudio v1.4 has embedded reticulate into the IDE. For example, you can define a default Python environment under Global Options or Project Options. You can also now inspect Python objects in the Environment pane. 5.2 ArcGIS &amp; API wrappers The Council’s ArcGIS software from ESRI has a much stronger integration with Python than R (see the section on RStudio security &amp; data protection for further notes about this). A similar area you may find Python packages but no corresponding R package, is a wrapper for a REST API that makes it easier to obtain data (see the section on wrappers for further notes about this). In both cases, reticulate allows us to leverage Python packages from within R. "],["gis.html", "Chapter 6 GIS 6.1 Spatial data 6.2 Web maps &amp; dashboards 6.3 Desktop GIS 6.4 Scripted GIS 6.5 Rasters 6.6 Further resources", " Chapter 6 GIS This chapter is aimed in particular at our data analysts with little or no experience of spatial data and GIS. GIS has traditionally been the domain of specialists and this is particularly true in the Council. However, the Council’s new web based GIS tools will open up GIS to a wider user base, with a particular opportunity for data analysts to make more use of spatial data without being a GIS specialist. A word of warning before you jump in, the guidance, examples and functions targeted at helping you use our spatial data is still very much work-in-progress (TODO). 6.1 Spatial data 6.1.1 Council’s spatial data The Council’s spatial data is hosted by ESRI’s ArcGIS web GIS tools. Portal (ArcGIS Enterprise) is Council-wide: sheffieldcitycouncil.cloud.esriuk.com/portal/home ArcGIS Online (AGOL) is the public facing equivalent of Portal: sheffieldcc.maps.arcgis.com Unlike R, ArcGIS is not open source and incurs a financial cost. Portal and AGOL require login credentials for both licensing and data protection purposes. The exception, is some public data on AGOL, for example the Council’s open data site: data-sheffieldcc.opendata.arcgis.com 6.1.2 Other spatial data ESRI’s Living Atlas has a lot of content, but I’ve yet to properly explore or use it (TODO). More specific to the UK, is spatial data from ONS and Ordnance Survey. There are some notes on accessing this data in the chapter on Public Data Sources under Open Geography Portal and OS Data Hub. 6.2 Web maps &amp; dashboards 6.2.1 ArcGIS The Council’s Portal and AGOL are the default home for our spatial data. Similarly, if you’re looking to not just extract spatial data, but to share it or share spatial analysis via a web map or dashboard, then the default is also the Council’s Portal and AGOL. To share content on Portal or AGOL you need a Creator license for which there is separate guidance (TODO - add cross ref.). 6.2.2 Power BI The GIS capabilities of Power BI do not match Portal or AGOL, but if only a small proportion of the analysis you are sharing is spatial then Power BI could be a good option. The ArcGIS Power BI integration tool is now available to us at no extra cost, but we are yet to test it (TODO). 6.3 Desktop GIS For some specialised spatial analysis a desktop GIS is best. However, as we move to sharing spatial information using web maps and dashboards, rather than static PDF maps, desktop GIS is increasingly a tool for GIS specialists. 6.3.1 ArcGIS Desktop For the last fifteen, twenty years, the Council’s spatial analysis has largely been done using ArcGIS Desktop from ESRI. This is a powerful piece of software, but for the majority of GIS uses, it’s a sledge hammer to crack a nut. If you’ve not done spatial analysis before, the recommendation is to first try our new, far more intuitive, ArcGIS web GIS tools i.e. our Portal and AGOL. ESRI have stopped development of ArcGIS Desktop, though it won’t be retired for some years yet. New functionality will only be added to ArcGIS Pro from now on. 6.3.2 ArcGIS Pro ArcGIS Pro is another desktop GIS application from ESRI. It isn’t as old as ArcGIS Desktop, so has less legacy issues, it is 64-bit and is more closely integrated with the ArcGIS Enterprise (Portal) and AGOL. However, the single biggest difference is that the hundreds of nested menu driven options are located in different places to ArcGIS Desktop! The Council has an ArcGIS Pro license for every purchased ArcGIS Desktop license. 6.3.3 QGIS QGIS is an open source alternative to ArcGIS Desktop and ArcGIS Pro. 6.4 Scripted GIS 6.4.1 Features The term “feature” is useful to distinguish a record as “spatial”. By “spatial” we mean it has a point, a line or a polygon. A point is a pair of coordinates, a line a minimum of two pairs of coordinates and polygons at least three pairs. Something to keep an eye out for is MULTIPOINT, multi-part polygons etc. This is a single record, a single feature, but it has more than one point, line or polygon. For example, Sheffield secondary school features might be MULTIPOINT so that the feature for King Edward VII school can have one point for the Lower School near Crosspool, and another point for the Upper School in Broomhill. 6.4.2 Simple features Simple features is an open standard developed by the Open Geospatial Consortium. It is a hierarchical data model that represents a wide range of geometry types, all of which are supported by the sf R package. The sf package also plays nice with the tidyverse. # Create a data frame with some example records df &lt;- tibble::tribble( ~name, ~postcode, ~longitude, ~latitude, &quot;SCC&quot;, &quot;S1 2HH&quot;, -1.470006, 53.38038, &quot;Blades&quot;, &quot;S2 4SU&quot;, -1.470512, 53.36986, &quot;Owls&quot;, &quot;S6 1SW&quot;, -1.500859, 53.41084 ) # Create simple features sf_shef &lt;- sf::st_as_sf(df, coords = c(&quot;longitude&quot;, &quot;latitude&quot;), #from postcodes.io crs = 4326) #WSG84 # Plot mapview::mapview(sf_shef, layer.name = &quot;Sheffield institutions&quot;) 6.4.3 Coordinates &amp; projections The minimum you need to know is that any spatial data you use is likely to involve one or more of three coordinate systems: WSG84 with an ESPG of 4326 Web Mercator with an EPSG of 3857 OSGB1936 (British National Grid) with an ESPG of 27700 Most web maps are based on features stored as WSG84 and displayed (projected) as Web Mercator. Postcodes.io uses WSG84, but the Council’s Portal and the ONS Open Geography Portal use OSGB1936 (BNG) (TODO: need to double check this!!). # Check the coordinate system of simple features sf::st_crs(sf_shef) ## Coordinate Reference System: ## User input: EPSG:4326 ## wkt: ## GEOGCRS[&quot;WGS 84&quot;, ## DATUM[&quot;World Geodetic System 1984&quot;, ## ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563, ## LENGTHUNIT[&quot;metre&quot;,1]]], ## PRIMEM[&quot;Greenwich&quot;,0, ## ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]], ## CS[ellipsoidal,2], ## AXIS[&quot;geodetic latitude (Lat)&quot;,north, ## ORDER[1], ## ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]], ## AXIS[&quot;geodetic longitude (Lon)&quot;,east, ## ORDER[2], ## ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]], ## USAGE[ ## SCOPE[&quot;unknown&quot;], ## AREA[&quot;World&quot;], ## BBOX[-90,-180,90,180]], ## ID[&quot;EPSG&quot;,4326]] 6.4.3.1 Geographic &amp; projected coordinate systems A reference ellipsoid as an approximation of the surface of the earth and provides a shape on which a coordinate system can be placed. Geographic coordinate systems use the ellipsoid to define specific locations on the surface to create a grid. Datums are geographic coordinate systems based on a specific ellipsoid (so a more specific geographic coordinate system), with an origin at a specific location, and the ellipsoid at a specific orientation. These are also called “spatial reference systems” or “coordinate reference systems”. Projected coordinate systems are like geographic coordinate systems. A projected coordinate system is also a grid used as a reference for locations on the planet, but it’s a translation of the three-dimensional grid onto a two-dimensional plane such as a paper map or screen. A GCS defines where the data is located on the earth’s surface. A PCS tells the data how to draw on a flat surface such as a screen. Coordinate systems, projected and geographic, are often identified by an EPSG code. 6.4.4 ArcGIS R &amp; Python packages Listed below are R and Python packages that allow us to leverage ArcGIS functionality. Generally speaking, they are in ascending order of both ease of use and scope of functionality. Package Language ArcGIS Desktop Install Required Scope esri2sf R ✕ Read from AGOL &amp; ArcGIS Enterprise arcgisbinding R ✓ Read &amp; write from AGOL &amp; ArcGIS Enterprise arcgis Python ✓ Access AGOL &amp; ArcGIS Enterprise functionality arcpy Python ✓ Access ArcGIS Desktop or Pro functionality 6.4.4.1 esri2sf The esri2sf R package is the only one of the four packages listed above that is not maintained by ESRI. It is the simplest to start using because it doesn’t require an installation and license for ArcGIS Desktop or Pro. The flip side, is that it has the least amount of functionality and the code isn’t as robust. The scope of the package is limited to reading simple features or data frames from AGOL &amp; ArcGIS Enterprise (ours or other organisation’s). The ONS Open Geography Portal is based on the same ArcGIS web tools as our Portal and AGOL. To get, for example, the local authority boundary for Sheffield you first need to navigate to the dataset on the website and get the GeoService API URL: Then, using: the copied GeoService URL, https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Local_Authority_Districts_December_2020_UK_BGC/FeatureServer/0/query?outFields=\\\\\\\\\\\\\\*&amp;where=1%3D1 some resources to understand how to query the API, ArcGIS REST API - Query (Feature Service/Layer) SQL 92 is used by ESRI based APIs HTML encoding is used for building URL queries and esri2sf, we can get the Sheffield boundary as a simple feature: TODO: install esri2sf via deploy_bookdown.yml # Base URL for ONS Open Geography Portal ons_geog_base_url &lt;- &quot;https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/&quot; # URL part for how detailed the local authority boundary should be generalised &lt;- &quot;Local_Authority_Districts_December_2020_UK_BGC&quot; # Get Sheffield MSOA boundaries as simple features shef_msoa &lt;- esri2sf::esri2sf(url = stringr::str_c(ons_geog_base_url, generalised, &quot;/FeatureServer/0&quot;), where = &quot;LAD20NM LIKE&#39;Sheffield%&#39;&quot;, geomType = &quot;esriGeometryPolygon&quot;) # Plot mapview::mapview(shef_msoa, layer.name = &quot;Sheffield&quot;) The example above reads open data. However, most of the Council’s spatial data on Portal and AGOL requires login credentials to to access. Nevertheless, Portal and AGOL login credentials are a smaller requirement than a ArcGIS Desktop or Pro installation and license. TODO - test and note authentication with token Our public github.com/scc-pi/functions repository includes functions in ShefAreas.R that use esri2sf. The sub-headings immediately below outline how other ArcGIS packages are more powerful, but also more onerous in terms of licensing and setup. So where possible, the intention is to utilise esri2sf in preference to the other ArcGIS packages. Relying on esri2sf may require some contributions to the esri2sf repository. For example, a pull request to fix an assumption that at least 500 features can be served at a time, when the ONS Open Geography Portal limit is 50 (hence our forked github.com/scc-pi/esri2sf repository). Contributing to esri2sf repository is preferable to accessing the Portal or AGOL API via Javascript, which is better suited to web developers than data analysts. Further information on the esri2sf package, how to install and use it, is available from github.com/yonghah/esri2sf. 6.4.4.2 R-ArcGIS Bridge The R-ArcGIS Bridge is the name for the arcgisbinding R package. It’s scope is restricted to: Transferring data in both directions between ArcGIS and R Wrapping R tools for use in ArcGIS For more information on using the arcgisbinding package see the vignette on Using the R-ArcGIS Bridge. To use the R-ArcGIS Bridge you need an installation and license for ArcGIS Desktop or Pro. After loading the arcgisbinding package you have to call arc.check_product() to define a desktop license: library(arcgisbinding) arc.check_product() Using arcgisbinding with ArcGIS Desktop means that you need to use 32-bit R, because ArcGIS Desktop is 32-bit. An ArcGIS Desktop 64-bit Background Geoprocessing option is a red herring because it only allows using the bridge from ArcGIS, not from within R itself. ArcGIS Pro is 64-bit and allows you to use use 64-bit R with arcgisbinding. The README.md in the r-bridge GitHub repository is the best starting point for more detail on R-ArcGIS Bridge requirements and installation. TODO: - open, select, read example (how do I render in GitHub Actions with arc.check_product()?) 6.4.4.3 ArcGIS Python API The Council’s ArcGIS software from ESRI has a much stronger integration with Python than R. The arcgis package is used to work with ArcGIS Enterprise (Portal) and AGOL. - The name of the package and it’s purpose - OneNote? To use the arcpy or arcgis packages we first need to specify the ArcGIS Python environment 6.4.4.4 ArcPy The arcpy package is used to leverage the ArcGIS Desktop or Pro functionality. Like the arcgis package, to use the arcpy package we first need to specify the ArcGIS Python environment. The distinction between web and desktop, for arcgis and arcpy packages respectively, is a bit of a simplification but it serves a purpose. It’s worth noting that the integration between the two packages isn’t as seamless as you might expect. TODO - setup - cross ref Docker 6.4.5 Leaflet TODO 6.5 Rasters TODO 6.6 Further resources Geocomputation with R, by Robin Lovelace mapview basics vignette Geographic vs Projected Coordinate Systems, Heather Smith, ArcGIS Blog (27 February 2020) EPSG 4326 vs EPSG 3857, Lyzi Diamond (26 May 2017) "],["geocoding.html", "Chapter 7 Postcodes &amp; Addresses 7.1 UPRN 7.2 Postcodes 7.3 Addresses", " Chapter 7 Postcodes &amp; Addresses A common use case in our work is to do some spatial analysis on a dataset with addresses. For example, produce a map of certain incidents over the last year, or summarise the number of incidents by Ward. 7.1 UPRN TODO 7.2 Postcodes If there’s no UPRN, getting a location via the postcode is usually the easiest option. It’s not as accurate as a UPRN or a full address, but often it’s accurate enough for what’s required. Below is an example of using our add_pcd_vars() function that builds on the PostcodesioR package, which itself is a wrapper for the postcodes.io API. You pass it a data frame with a postcode column and it returns the data frame with new columns based on the postcode. # Create a data frame with some example records df &lt;- tibble::tribble( ~name, ~postcode, &quot;SCC, Town Hall&quot;, &quot;S1 2HH&quot;, &quot;Blades, Bramall Lane&quot;, &quot;S2 4SU&quot;, &quot;Owls, Hillsborough&quot;, &quot;S6 1SW&quot; ) # Load the function we need source(&quot;https://raw.githubusercontent.com/scc-pi/functions/main/Addresses.R&quot;) # Add postcode related columns to our data frame add_pcd_vars(df, pcd_name = &quot;postcode&quot;, .admin_district = FALSE, .lat_long = TRUE, other_vars = c(&quot;admin_ward&quot;, &quot;msoa_code&quot;)) %&gt;% knitr::kable() #display them in a nice table name postcode longitude latitude admin_ward msoa_code SCC, Town Hall S1 2HH -1.470006 53.38038 City E02006843 Blades, Bramall Lane S2 4SU -1.470512 53.36986 City E02001652 Owls, Hillsborough S6 1SW -1.500859 53.41084 Hillsborough E02001627 admin_district can be used to answer the questions: Is the postcode invalid? Is the postcode in Sheffield? You can anticipate values of NA and Sheffield respectively if the answers are yes. These are common questions so the function has an .admin_district argument. Needing the coordinates of the postcode centroid is also common, so the function also has a .lat_long argument that if TRUE returns both a latitude column and a longitude column. TODO: link to sf example &amp; area stats Other columns are added by including their name in a character vector passed with the other_vars function argument. For example, other_vars=c(\"ccg_code\",\"lsoa_code\"). The list of valid other_vars is defined at docs.ropensci.org/PostcodesioR/#examples. The pcd_name function argument is used to specify the name of the data frame’s postcode column when it isn’t postcode. For example, pcd_name=\"pupil_pcode\". Sometimes, the postcode in a dataset is not included as a separate column, but is at the end of a combined address column. Depending on the format and quality of the combined address column you could extract the postcode like this: # Create a data frame with some example records df &lt;- tibble::tribble( ~name, ~address, &quot;SCC&quot;, &quot;Pinstone St, Sheffield City Centre, Sheffield S1 2HH&quot;, &quot;Blades&quot;, &quot;Bramall Ln, Highfield, Sheffield S2 4SU&quot;, &quot;Owls&quot;, &quot;76 Penistone Rd N, Sheffield S6 1SW&quot; ) # Extract the postcode from the address into a separate column dplyr::mutate(df, postcode = stringr::word(address, -2, -1, sep = &quot;[:space:]&quot;)) %&gt;% knitr::kable() name address postcode SCC Pinstone St, Sheffield City Centre, Sheffield S1 2HH S1 2HH Blades Bramall Ln, Highfield, Sheffield S2 4SU S2 4SU Owls 76 Penistone Rd N, Sheffield S6 1SW S6 1SW 7.2.1 PAS Postcode Lookup PAS, the Performance &amp; Analysis Service in the People Porfolio, maintains a postcode lookup table that performs the same role as the add_pcd_vars() function. TODO: Does it also include Sheffield specific variables e.g. which of the 100 neighbourhoods is the postcode in? 7.2.2 Split postcodes TODO 7.3 Addresses TODO - Portal LLPG Cascade Locator - OS Places ESRI integration "],["public-data.html", "Chapter 8 Public Data Sources 8.1 Office of National Statistics 8.2 Ministry of Housing, Communities &amp; Local Government 8.3 Ordnance Survey 8.4 LGInform?", " Chapter 8 Public Data Sources 8.1 Office of National Statistics TODO 8.1.1 CRM TODO 8.1.2 NOMIS TODO 8.1.3 Open Geography Portal TODO 8.2 Ministry of Housing, Communities &amp; Local Government Official statistics from MHCLG (Ministry of Housing, Communities &amp; Local Government): opendatacommunities.org https://guides.opendatacommunities.org/article/19-apis-part-2-using-r-with-the-apis 8.3 Ordnance Survey TODO 8.3.1 OS Data Hub TODO 8.4 LGInform? "],["databases.html", "Chapter 9 Databases 9.1 Corporate data warehouse 9.2 Corporate spatial database 9.3 SQLite 9.4 Further resources", " Chapter 9 Databases 9.1 Corporate data warehouse 9.1.1 OSCAR TODO 9.2 Corporate spatial database TODO 9.3 SQLite Access to an SQLite database is controlled by permissions on the folder where it is stored. Unlike other databases, you do not create users who are authenticated by the database, and you do not grant privileges on specific datasets to other users. SQLite is also different from other databases in that fields are not assigned specific data types and data type definitions are not strictly enforced. Instead, SQLite uses storage classes in which values of different data types can be stored. In particular, date types are handled differently. ArcGIS handles SQLite dates without needing any special attention, but reading dates from SQLite in to R or Power BI needs attention. For example, by using the JD() function from the insol package: # Convert dates we&#39;ve read from a SQLite database mutate(date = JD(date, inverse = TRUE), week_end = JD(week_end, inverse = TRUE)) 9.3.1 SpatiaLite SpatiaLite extends SQLite to support spatial data. The RSQLite package includes the driver for SpatiaLite. Robin Lovelace has a chapter on spatial databases in his book Geocomputation with R. After testing different options, SpatiaLite is the best file based database for access to spatial data via tools such as R and Power BI without the complication of ArcGIS licenses, but it also provides reliable access for ArcGIS. So far I’ve only tested SpatiaLite databases created in ArcGIS 9.4 Further resources Databases using R from RStudio "],["other.html", "Chapter 10 Other 10.1 renv 10.2 Docker 10.3 reprex R package 10.4 Writing R packages 10.5 plumber R package 10.6 Data Visualisation", " Chapter 10 Other This is a dumping ground for matters I’m yet to look in to properly, never mind write notes about. 10.1 renv Introduction to renv vignette 10.2 Docker Using docker containers means you don’t have to deal with “works on my machine” problems. Currently, the set-up and reproducibility issues I’ve had with arcpy and Jupyter notebooks means I can’t recommend others in the Council go down this path and therefore collaborate with these tools. Could Docker be a means to address these issues, or at the very least, allow officers to trial arcpy and Jupyter notebooks before investing in a complicated setup? For more typical R projects renv might be preferable. Docker for Data Science — A Step by Step Guide, Dean Pleban (18 October 2020) The Pros and Cons of Docker, Nick from Iron.io (28 August 2020) Play with Docker rocker R package 10.3 reprex R package reprex.tidyverse.org 10.4 Writing R packages R Packages by Hadley Wickham &amp; Jenny Bryan 10.4.1 roxygen2 Introduction to roxygen2 vignette 10.3 Roxygen comments 10.5 plumber R package rplumber.io 10.6 Data Visualisation Data Visualization, A practical introduction by Kieran Healy "],["references.html", "References", " References "]]
